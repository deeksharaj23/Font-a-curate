<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Font-a-curate</title>
    <style>
      *,
      *::before,
      *::after {
        box-sizing: border-box;
      }

      :root {
        --pad: 14px;
        --bg: #f6f7fb;
        --surface: #ffffff;
        --text: #111827;
        --muted: #6b7280;
        --border: rgba(17, 24, 39, 0.12);
        --chip: rgba(17, 24, 39, 0.06);
        --accent: #7c3aed;
        --accentHover: #6d28d9;
        --accentSoft: rgba(124, 58, 237, 0.14);
        --accentSoftStrong: rgba(124, 58, 237, 0.24);
        --radius: 12px;
      }

      body {
        margin: 0;
        padding: 0;
        font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji",
          "Segoe UI Emoji";
        background: var(--bg);
        color: var(--text);
      }

      .app {
        display: grid;
      }

      .top {
        padding: 10px var(--pad) 10px var(--pad);
        display: grid;
        gap: 8px;
        background: var(--surface);
        border-bottom: 1px solid rgba(17, 24, 39, 0.08);
        box-shadow: 0 2px 10px rgba(17, 24, 39, 0.06);
        position: sticky;
        top: 0;
        z-index: 10;
      }

      .filtersRow {
        display: grid;
        gap: 12px;
      }

      .filters {
        display: grid;
        grid-template-columns: repeat(3, minmax(0, 1fr));
        gap: 12px;
        align-items: end;
      }

      .filter {
        flex: 1;
        min-width: 0;
        width: 100%;
      }

      .label {
        display: block;
        font-size: 10px;
        color: var(--muted);
        margin: 0 0 4px 2px;
        letter-spacing: 0.02em;
      }

      details.ms {
        position: relative;
        display: block;
        width: 100%;
      }

      details.ms summary {
        list-style: none;
        cursor: pointer;
        user-select: none;
        width: 100%;
        font-size: 12px;
        padding: 9px 34px 9px 12px;
        border: 1px solid var(--border);
        border-radius: 10px;
        background-color: #fff;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 20 20'%3E%3Cpath fill='%236b7280' d='M5.6 7.9a1 1 0 0 1 1.4 0L10 10.9l3-3a1 1 0 1 1 1.4 1.4l-3.7 3.7a1 1 0 0 1-1.4 0L5.6 9.3a1 1 0 0 1 0-1.4z'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 12px center;
        background-size: 16px 16px;
        color: var(--text);
        outline: none;
        transition: border-color 120ms ease, box-shadow 120ms ease, background-color 120ms ease;
        display: block;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      details.ms summary::-webkit-details-marker {
        display: none;
      }

      details.ms summary:hover {
        border-color: rgba(124, 58, 237, 0.35);
        background-color: rgba(124, 58, 237, 0.02);
      }

      details.ms[open] summary {
        border-color: var(--accent);
        box-shadow: inset 0 0 0 2px rgba(124, 58, 237, 0.55);
      }

      details.ms[open] {
        z-index: 25;
      }

      .msMenu {
        position: absolute;
        top: calc(100% + 8px);
        left: 0;
        right: 0;
        background: #ffffff;
        border: 1px solid rgba(17, 24, 39, 0.12);
        border-radius: 12px;
        box-shadow: 0 18px 40px rgba(17, 24, 39, 0.14);
        padding: 8px;
        max-height: 240px;
        overflow: auto;
        z-index: 30;
      }

      .msOption {
        display: flex;
        gap: 10px;
        align-items: center;
        padding: 8px 8px;
        border-radius: 10px;
        font-size: 12px;
        color: rgba(17, 24, 39, 0.92);
      }

      .msOption:hover {
        background: rgba(124, 58, 237, 0.06);
      }

      .msOption input[type="checkbox"] {
        accent-color: var(--accent);
      }

      .previewControl {
        display: flex;
        gap: 10px;
        align-items: flex-end;
      }

      .previewToggleRow {
        display: flex;
        align-items: center;
      }

      .sectionDivider {
        height: 1px;
        background: rgba(17, 24, 39, 0.08);
        margin: 2px 0 0 0;
      }

      .previewToggle {
        width: fit-content;
        text-align: left;
        font-size: 12px;
        padding: 4px 2px;
        border: none;
        border-radius: 10px;
        background: transparent;
        color: rgba(17, 24, 39, 0.88);
        cursor: pointer;
        font-weight: 400;
        letter-spacing: 0.01em;
        transition: color 140ms ease;
        display: inline-flex;
        align-items: center;
        gap: 12px;
      }

      .previewToggle:hover {
        color: var(--accent);
        background: transparent;
        border-color: transparent;
        box-shadow: none;
      }

      .previewToggle:focus {
        outline: none;
        box-shadow: 0 0 0 3px var(--accentSoft);
      }

      .previewToggle[aria-expanded="true"] {
        color: var(--accent);
        background: transparent;
        border-color: transparent;
        box-shadow: none;
      }

      .previewWrap {
        overflow: hidden;
        max-height: 0;
        opacity: 0;
        transform: translateY(-6px);
        transition: max-height 240ms ease, opacity 180ms ease, transform 240ms ease;
      }

      .previewWrap.open {
        max-height: 140px;
        opacity: 1;
        transform: translateY(0);
      }

      .previewField {
        flex: 1;
        min-width: 0;
        display: grid;
        gap: 4px;
      }

      input.previewInput {
        width: 100%;
        font-size: 12px;
        padding: 8px 12px;
        border: 1px solid var(--border);
        border-radius: 10px;
        background: #fff;
        color: var(--text);
        outline: none;
        transition: border-color 120ms ease, box-shadow 120ms ease, background-color 120ms ease;
      }

      input.previewInput::placeholder {
        color: rgba(17, 24, 39, 0.38);
      }

      input.previewInput:hover {
        border-color: rgba(124, 58, 237, 0.35);
        background-color: rgba(124, 58, 237, 0.02);
      }

      input.previewInput:focus {
        border-color: var(--accent);
        box-shadow: inset 0 0 0 2px rgba(124, 58, 237, 0.45);
      }

      .resultsMeta {
        padding: 10px var(--pad) 0 var(--pad);
        font-size: 11px;
        color: rgba(17, 24, 39, 0.58);
        letter-spacing: 0.01em;
      }

      .topDivider {
        height: 1px;
        background: rgba(17, 24, 39, 0.08);
        margin: 2px 0 0 0;
      }

      .grid {
        padding: var(--pad);
        padding-top: 10px;
        display: grid;
        gap: 12px;
        padding-bottom: 10px;
      }

      .emptyState {
        border: 1px dashed var(--border);
        border-radius: var(--radius);
        padding: 18px 14px;
        color: var(--muted);
        text-align: center;
        line-height: 1.35;
      }

      .emptyStateTitle {
        font-size: 13px;
        font-weight: 650;
        color: rgba(17, 24, 39, 0.82);
        margin-bottom: 4px;
      }

      .emptyStateBody {
        font-size: 12px;
      }

      .tile {
        border: 1px solid rgba(17, 24, 39, 0.1);
        border-radius: var(--radius);
        overflow: hidden;
        background: #fff;
        box-shadow: 0 1px 2px rgba(17, 24, 39, 0.06);
        transition: border-color 140ms ease, box-shadow 140ms ease, transform 140ms ease;
      }

      .tile:hover {
        border-color: rgba(124, 58, 237, 0.18);
        box-shadow: 0 10px 24px rgba(17, 24, 39, 0.08);
        transform: translateY(-1px);
      }

      .preview {
        padding: 12px 12px 10px 12px;
      }

      .previewTitle {
        font-size: 34px;
        line-height: 1.05;
        letter-spacing: -0.02em;
        margin: 0 0 8px 0;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
      }

      .previewBody {
        font-size: 14px;
        line-height: 1.45;
        margin: 0;
        color: rgba(17, 24, 39, 0.92);
        display: -webkit-box;
        -webkit-line-clamp: 3;
        -webkit-box-orient: vertical;
        overflow: hidden;
      }

      .tileDivider {
        height: 1px;
        background: rgba(17, 24, 39, 0.08);
        margin: 0 12px;
      }

      .meta {
        padding: 10px 12px 12px 12px;
        display: flex;
        align-items: flex-end;
        justify-content: space-between;
        gap: 10px;
      }

      .names {
        display: grid;
        gap: 3px;
        min-width: 0;
      }

      .nameRow {
        display: grid;
        grid-template-columns: 44px 1fr;
        gap: 8px;
        font-size: 12px;
      }

      .nameRow span:first-child {
        color: var(--muted);
      }

      .nameRow span:last-child {
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }

      .tags {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        margin-top: 8px;
      }

      .previewTags {
        margin-top: 10px;
      }

      .tag {
        font-size: 11px;
        padding: 4px 8px;
        border-radius: 999px;
        background: var(--chip);
        color: rgba(17, 24, 39, 0.86);
        transition: background-color 120ms ease, color 120ms ease;
      }

      .tile:hover .tag {
        background: rgba(17, 24, 39, 0.08);
      }

      .actions {
        display: flex;
        justify-content: flex-end;
        gap: 8px;
        flex-shrink: 0;
      }

      .actions button {
        font-size: 12px;
        padding: 8px 12px;
        border-radius: 999px;
        border: 1px solid var(--accent);
        background: var(--accent);
        color: #ffffff;
        cursor: pointer;
        letter-spacing: 0.1px;
        transition: transform 120ms ease, box-shadow 120ms ease, filter 120ms ease, background-color 120ms ease,
          border-color 120ms ease;
      }

      .actions button.secondary {
        background: #ffffff;
        color: rgba(17, 24, 39, 0.92);
        border-color: rgba(17, 24, 39, 0.14);
      }

      .actions button:hover {
        background: var(--accentHover);
        border-color: var(--accentHover);
        box-shadow: 0 10px 22px rgba(124, 58, 237, 0.22);
      }

      .actions button:active {
        transform: translateY(1px);
      }

      .actions button.secondary:hover {
        background-color: rgba(124, 58, 237, 0.04);
        border-color: rgba(124, 58, 237, 0.35);
        box-shadow: 0 8px 18px rgba(17, 24, 39, 0.08);
      }

      .actions button:focus {
        outline: none;
        box-shadow: 0 0 0 3px var(--accentSoftStrong);
      }

      @media (max-width: 420px) {
        .filters {
          grid-template-columns: repeat(2, minmax(140px, 1fr));
        }
      }

      @media (max-width: 300px) {
        .filters {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <div class="app">
      <div class="top">
        <div class="filtersRow">
          <div class="filters">
            <div class="filter">
              <div class="label">Style</div>
              <details class="ms" id="themeMs">
                <summary><span id="themeSummary">All</span></summary>
                <div class="msMenu" id="themeMenu"></div>
              </details>
            </div>
            <div class="filter">
              <div class="label">Font Type</div>
              <details class="ms" id="typeMs">
                <summary><span id="typeSummary">All</span></summary>
                <div class="msMenu" id="typeMenu"></div>
              </details>
            </div>
            <div class="filter">
              <div class="label">Readability</div>
              <details class="ms" id="accessibilityMs">
                <summary><span id="accessibilitySummary">All</span></summary>
                <div class="msMenu" id="accessibilityMenu"></div>
              </details>
            </div>
          </div>
        </div>

        <div class="sectionDivider"></div>

        <div class="previewToggleRow">
          <button class="previewToggle" id="previewToggle" type="button" aria-expanded="false">
            <span>Add preview text</span>
          </button>
        </div>

        <div class="previewWrap" id="previewWrap">
          <div class="previewControl" style="padding-top: 8px;">
            <div class="previewField">
              <div class="label">Title</div>
              <input
                class="previewInput"
                id="previewTitle"
                type="text"
                placeholder="Add preview title text"
                autocomplete="off"
              />
            </div>
            <div class="previewField">
              <div class="label">Body</div>
              <input
                class="previewInput"
                id="previewBody"
                type="text"
                placeholder="Add preview body text"
                autocomplete="off"
              />
            </div>
          </div>
        </div>
      </div>

      <div class="resultsMeta" id="resultsCount">—</div>
      <div class="grid" id="grid"></div>
    </div>

    <script>
      const ALL = "All";
      const DEFAULT_BODY =
        "The perfect title and body font pair is when two fonts work together to create clear hierarchy, balance, and visual harmony in a design.";

      const ALL_VALUE = "all";

      /** @type {{ pairs: any[], filters: { theme: Set<string>, accessibility: Set<string>, type: Set<string> } }} */
      const state = {
        pairs: [],
        filters: { theme: new Set([ALL_VALUE]), accessibility: new Set([ALL_VALUE]), type: new Set([ALL_VALUE]) },
        previewTitleText: "",
        previewBodyText: "",
      };

      const loadedFamilies = new Set();

      function toFamilyParam(family) {
        // Google Fonts CSS2 family param prefers + for spaces.
        return encodeURIComponent(family).replace(/%20/g, "+");
      }

      function ensureFontsLoaded(titleFont, bodyFont) {
        const missing = [];
        if (!loadedFamilies.has(titleFont)) missing.push(titleFont);
        if (!loadedFamilies.has(bodyFont)) missing.push(bodyFont);
        if (missing.length === 0) return;

        missing.forEach((f) => loadedFamilies.add(f));

        const url =
          "https://fonts.googleapis.com/css2?" +
          missing.map((f) => "family=" + toFamilyParam(f)).join("&") +
          "&display=swap";

        const link = document.createElement("link");
        link.rel = "stylesheet";
        link.href = url;
        document.head.appendChild(link);
      }

      const FILTER_OPTIONS = {
        theme: [
          { value: ALL_VALUE, label: "All" },
          { value: "formal", label: "Formal" },
          { value: "elegant", label: "Elegant" },
          { value: "friendly", label: "Friendly" },
          { value: "playful", label: "Playful" },
          { value: "modern", label: "Modern" },
          { value: "classic", label: "Classic" },
          { value: "professional", label: "Professional" },
        ],
        accessibility: [
          { value: ALL_VALUE, label: "All" },
          { value: "long-form-text", label: "Long form text" },
          { value: "dyslexic-friendly", label: "Dyslexic friendly" },
          { value: "monospaced", label: "Monospaced" },
        ],
        type: [
          { value: ALL_VALUE, label: "All" },
          { value: "serif", label: "Serif" },
          { value: "sans-serif", label: "Sans-Serif" },
          { value: "slab-serif", label: "Slab Serif" },
          { value: "display", label: "Display" },
          { value: "script", label: "Script" },
          { value: "monospace", label: "Monospace" },
          { value: "variable", label: "Variable" },
          { value: "handwritten", label: "Handwritten" },
        ],
      };

      function summarizeSelection(key) {
        const selected = state.filters[key];
        if (!selected || selected.has(ALL_VALUE) || selected.size === 0) return "All";

        const opts = FILTER_OPTIONS[key];
        const labels = [];
        for (const o of opts) {
          if (o.value !== ALL_VALUE && selected.has(o.value)) labels.push(o.label);
        }

        if (labels.length === 0) return "All";
        if (labels.length === 1) return labels[0];
        if (labels.length === 2) return `${labels[0]}, ${labels[1]}`;
        return `${labels[0]}, ${labels[1]} +${labels.length - 2}`;
      }

      function syncSummary(key) {
        document.getElementById(`${key}Summary`).textContent = summarizeSelection(key);
      }

      function syncCheckboxes(key) {
        const selected = state.filters[key];
        const menu = document.getElementById(`${key}Menu`);
        menu.querySelectorAll('input[type="checkbox"]').forEach((el) => {
          el.checked = selected.has(el.value);
        });
      }

      function setAllSelected(key) {
        state.filters[key] = new Set([ALL_VALUE]);
        syncCheckboxes(key);
        syncSummary(key);
      }

      function handleMultiSelectChange(key, value, checked) {
        const selected = new Set(state.filters[key]);

        if (value === ALL_VALUE) {
          setAllSelected(key);
          render();
          return;
        }

        selected.delete(ALL_VALUE);
        if (checked) selected.add(value);
        else selected.delete(value);

        if (selected.size === 0) selected.add(ALL_VALUE);
        state.filters[key] = selected;
        syncCheckboxes(key);
        syncSummary(key);
        render();
      }

      function initMultiSelect(key) {
        const menu = document.getElementById(`${key}Menu`);
        menu.innerHTML = FILTER_OPTIONS[key]
          .map(
            (o) => `
              <label class="msOption">
                <input type="checkbox" value="${o.value}" />
                <span>${o.label}</span>
              </label>
            `
          )
          .join("");

        menu.addEventListener("change", (e) => {
          const t = e.target;
          if (!t || t.tagName !== "INPUT") return;
          handleMultiSelectChange(key, t.value, t.checked);
        });

        syncCheckboxes(key);
        syncSummary(key);
      }

      function initFilters() {
        initMultiSelect("theme");
        initMultiSelect("accessibility");
        initMultiSelect("type");

        // Prevent overlapping dropdown menus: only one open at a time.
        const allDetails = Array.from(document.querySelectorAll("details.ms"));
        allDetails.forEach((d) => {
          d.addEventListener("toggle", () => {
            if (!d.open) return;
            allDetails.forEach((other) => {
              if (other !== d) other.open = false;
            });
          });
        });

        // Click outside closes any open dropdown.
        document.addEventListener("click", (e) => {
          const target = e.target;
          if (target && target.closest && target.closest("details.ms")) return;
          allDetails.forEach((d) => (d.open = false));
        });

        // Preview text collapsible section
        const previewToggle = document.getElementById("previewToggle");
        const previewWrap = document.getElementById("previewWrap");
        previewToggle.addEventListener("click", () => {
          const isOpen = previewWrap.classList.toggle("open");
          previewToggle.setAttribute("aria-expanded", isOpen ? "true" : "false");
        });

        document.getElementById("previewTitle").addEventListener("input", (e) => {
          state.previewTitleText = e.target.value || "";
          render();
        });

        document.getElementById("previewBody").addEventListener("input", (e) => {
          state.previewBodyText = e.target.value || "";
          render();
        });
      }

      function matchesAllFilters(pair) {
        const t = effectiveTheme(pair);
        const a = effectiveAccessibility(pair);
        const types = effectiveTypeSet(pair);

        const themeSel = state.filters.theme;
        const accSel = state.filters.accessibility;
        const typeSel = state.filters.type;

        if (!themeSel.has(ALL_VALUE) && !themeSel.has(t)) return false;
        if (!accSel.has(ALL_VALUE) && !accSel.has(a)) return false;

        if (!typeSel.has(ALL_VALUE)) {
          let ok = false;
          for (const v of typeSel) {
            if (types.has(v)) {
              ok = true;
              break;
            }
          }
          if (!ok) return false;
        }
        return true;
      }

      const THEME_LABELS = {
        formal: "Formal",
        elegant: "Elegant",
        friendly: "Friendly",
        playful: "Playful",
        modern: "Modern",
        classic: "Classic",
        professional: "Professional",
      };

      const ACCESS_LABELS = {
        "long-form-text": "Long form text",
        "dyslexic-friendly": "Dyslexic friendly",
        monospaced: "Monospaced",
      };

      function themeLabel(value) {
        return THEME_LABELS[value] || value;
      }

      function accessibilityLabel(value) {
        return ACCESS_LABELS[value] || value;
      }

      const FONT_TYPES = {
        Inter: ["sans-serif", "variable"],
        "Source Sans 3": ["sans-serif", "variable"],
        Roboto: ["sans-serif"],
        "IBM Plex Sans": ["sans-serif"],
        "Work Sans": ["sans-serif", "variable"],
        "Noto Sans": ["sans-serif", "variable"],
        Lexend: ["sans-serif", "variable"],
        "Hanken Grotesk": ["sans-serif", "variable"],
        "Plus Jakarta Sans": ["sans-serif", "variable"],
        Manrope: ["sans-serif", "variable"],
        Urbanist: ["sans-serif", "variable"],
        Sora: ["sans-serif", "variable"],
        Outfit: ["sans-serif", "variable"],
        "Source Serif 4": ["serif", "variable"],
        "Playfair Display": ["serif", "display"],
        "DM Serif Display": ["serif", "display"],
        Fraunces: ["serif", "variable"],
        "Space Grotesk": ["sans-serif", "variable"],
        "DM Sans": ["sans-serif"],
        Montserrat: ["sans-serif", "variable"],
        "Bebas Neue": ["display"],
        Oswald: ["display", "variable"],
        "Roboto Mono": ["monospace"],
        "IBM Plex Mono": ["monospace"],
        "Roboto Slab": ["slab-serif", "serif", "variable"],
        "Dancing Script": ["script", "display"],
        Caveat: ["handwritten", "display"],
        Pacifico: ["script", "handwritten", "display"],
        Sacramento: ["script", "display"],
        Satisfy: ["script", "display"],
        "Great Vibes": ["script", "display"],
        "Patrick Hand": ["handwritten", "display"],
        "Indie Flower": ["handwritten", "display"],
        Kalam: ["handwritten", "display"],
        "Permanent Marker": ["handwritten", "display"],
        Handlee: ["handwritten", "display"],
        "Shadows Into Light": ["handwritten", "display"],
      };

      function fontTypeSet(family) {
        const tags = FONT_TYPES[family] || [];
        const set = new Set(tags);
        if (set.size === 0) {
          // Fallback: infer basic types from name patterns.
          if (String(family).includes("Mono")) set.add("monospace");
          else set.add("sans-serif");
        }
        return set;
      }

      function effectiveTypeSet(pair) {
        const out = new Set();
        for (const t of fontTypeSet(pair.titleFont)) out.add(t);
        for (const t of fontTypeSet(pair.bodyFont)) out.add(t);
        return out;
      }

      function effectiveAccessibility(pair) {
        if (pair.accessibility) return pair.accessibility;
        const body = pair.bodyFont;
        if (body === "Source Serif 4") return "long-form-text";
        if (body === "Lexend") return "dyslexic-friendly";
        if (body === "Roboto Mono" || body === "IBM Plex Mono") return "monospaced";
        return "none";
      }

      function effectiveTheme(pair) {
        if (pair.theme) return pair.theme;

        const title = pair.titleFont;
        const body = pair.bodyFont;
        const structure = pair.structure;
        const useCase = pair.useCase;
        const contrast = pair.contrast;
        const readability = pair.readability;

        const scores = {
          formal: 0,
          elegant: 0,
          friendly: 0,
          playful: 0,
          modern: 0,
          classic: 0,
          professional: 0,
        };

        // Helper: apply points in a readable way
        function add(theme, points) {
          scores[theme] += points;
        }

        // --- Font family signals (strong cues) ---
        if (title === "Bebas Neue" || title === "Oswald") add("playful", 6);
        if (title === "Playfair Display") add("elegant", 5);
        if (title === "DM Serif Display") add("formal", 5);
        if (title === "Fraunces") add("classic", 4);
        if (title === "Space Grotesk" || title === "Montserrat") add("modern", 4);
        if (title === "DM Sans") add("friendly", 2);

        if (body === "Source Serif 4") add("classic", 5);
        if (body === "Lexend") add("friendly", 6);
        if (body === "Roboto Mono" || body === "IBM Plex Mono") add("professional", 3);

        // --- Structure signals (supports hierarchy/feel) ---
        if (structure === "display-sans") add("playful", 5);
        if (structure === "serif-serif") {
          add("classic", 3);
          add("elegant", 2);
          add("formal", 1);
        }
        if (structure === "serif-sans") {
          add("elegant", 3);
          add("formal", 2);
          add("classic", 1);
        }
        if (structure === "sans-sans") {
          add("modern", 2);
          add("professional", 2);
          add("friendly", 1);
        }

        // --- Use-case signals (intent + tone constraints) ---
        if (useCase === "marketing") add("playful", 5);
        if (useCase === "luxury") add("elegant", 5);
        if (useCase === "editorial") add("classic", 4);
        if (useCase === "branding") {
          add("elegant", 2);
          add("formal", 1);
        }
        if (useCase === "ui" || useCase === "saas") add("professional", 3);

        // --- Contrast signals (how “loud” the pairing is) ---
        if (contrast === "high") {
          add("elegant", 2);
          add("playful", 1);
          add("formal", -1);
          add("professional", -1);
        } else if (contrast === "low") {
          add("professional", 2);
          add("friendly", 1);
          add("playful", -1);
        } else if (contrast === "medium") {
          add("modern", 1);
          add("elegant", 1);
        }

        // --- Readability signals (body stability) ---
        if (readability === "high") {
          add("professional", 1);
          add("friendly", 1);
        } else if (readability === "expressive") {
          add("playful", 1);
          add("elegant", 1);
          add("professional", -1);
        }

        // Soft constraints to avoid weird assignments
        if (useCase === "marketing") add("formal", -3);
        if (structure === "display-sans") add("formal", -2);
        if (structure === "display-sans") add("classic", -2);

        // Deterministic tie-breaker order
        const order = ["elegant", "formal", "modern", "professional", "friendly", "classic", "playful"];
        let best = "professional";
        let bestScore = -Infinity;
        for (const t of order) {
          const s = scores[t];
          if (s > bestScore) {
            bestScore = s;
            best = t;
          }
        }

        return best;
      }

      function escapeHtmlAttr(value) {
        return String(value)
          .replace(/&/g, "&amp;")
          .replace(/"/g, "&quot;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;");
      }

      function escapeHtml(value) {
        return String(value)
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;");
      }

      function cssFontFamily(family) {
        // Use single quotes so the style="" attribute stays valid.
        const safe = String(family).replace(/'/g, "\\'");
        return `'${safe}', ui-sans-serif, system-ui`;
      }

      function render() {
        const grid = document.getElementById("grid");
        const filtered = state.pairs.filter(matchesAllFilters);
        document.getElementById("resultsCount").textContent = `${filtered.length} pair${filtered.length === 1 ? "" : "s"}`;

        if (filtered.length === 0) {
          grid.innerHTML = `
            <div class="emptyState">
              <div class="emptyStateTitle">No pairings found</div>
              <div class="emptyStateBody">Try setting one or more filters back to “All”.</div>
            </div>
          `;
          return;
        }

        const customTitle = String(state.previewTitleText || "").trim();
        const customBody = String(state.previewBodyText || "").trim();

        grid.innerHTML = filtered
          .map((pair) => {
            ensureFontsLoaded(pair.titleFont, pair.bodyFont);
            const titleStyle = `font-family: ${cssFontFamily(pair.titleFont)};`;
            const bodyStyle = `font-family: ${cssFontFamily(pair.bodyFont)};`;
            const titleAttr = escapeHtmlAttr(pair.titleFont);
            const bodyAttr = escapeHtmlAttr(pair.bodyFont);
            const previewTitle = customTitle || `${pair.titleFont} & ${pair.bodyFont}`;
            const previewBody = customBody || DEFAULT_BODY;

            return `
              <div class="tile">
                <div class="preview">
                  <div class="previewTitle" style="${titleStyle}">${escapeHtml(previewTitle)}</div>
                  <p class="previewBody" style="${bodyStyle}">
                    ${escapeHtml(previewBody)}
                  </p>
                  <div class="tags previewTags">
                    <span class="tag">${themeLabel(effectiveTheme(pair))}</span>
                    ${
                      effectiveAccessibility(pair) !== "none"
                        ? `<span class="tag">${accessibilityLabel(effectiveAccessibility(pair))}</span>`
                        : ""
                    }
                  </div>
                </div>
                <div class="tileDivider"></div>
                <div class="meta">
                  <div class="names">
                    <div class="nameRow"><span>Title</span><span>${pair.titleFont}</span></div>
                    <div class="nameRow"><span>Body</span><span>${pair.bodyFont}</span></div>
                  </div>
                  <div class="actions">
                    <button class="secondary" data-action="add" data-title="${titleAttr}" data-body="${bodyAttr}">Add to canvas</button>
                    <button data-action="applyToText" data-title="${titleAttr}" data-body="${bodyAttr}">Apply to text</button>
                  </div>
                </div>
              </div>
            `;
          })
          .join("");
      }

      document.getElementById("grid").addEventListener("click", (e) => {
        const btn = e.target.closest('button[data-action]');
        if (!btn) return;
        const titleFont = btn.getAttribute("data-title");
        const bodyFont = btn.getAttribute("data-body");
        const action = btn.getAttribute("data-action");
        if (action === "add") {
          parent.postMessage(
            {
              pluginMessage: {
                type: "ADD_TO_CANVAS",
                titleFont,
                bodyFont,
                titleText: state.previewTitleText || "",
                bodyText: state.previewBodyText || "",
              },
            },
            "*"
          );
          return;
        }
        if (action === "applyToText") {
          parent.postMessage({ pluginMessage: { type: "APPLY_TO_TEXT", titleFont, bodyFont } }, "*");
        }
      });

      window.onmessage = (event) => {
        const msg = event.data.pluginMessage;
        if (!msg) return;

        if (msg.type === "PAIRS") {
          state.pairs = msg.pairs || [];
          render();
        }
      };

      initFilters();
      parent.postMessage({ pluginMessage: { type: "REQUEST_PAIRS" } }, "*");
    </script>
  </body>
</html>
